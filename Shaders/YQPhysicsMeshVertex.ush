#define YQ_PHYSICS_CUSTOM_VS_IN_EDITOR 1

#ifdef VF_YQ_PHYSICS

struct FVertexFactoryInput
{
	uint VertexId : SV_VertexID;

	float4	Position	: ATTRIBUTE0;

	#if METAL_PROFILE
		float3	TangentX	: ATTRIBUTE1;
		// TangentZ.w contains sign of tangent basis determinant
		float4	TangentZ	: ATTRIBUTE2;

	#else
		HALF3_TYPE	TangentX	: ATTRIBUTE1;
		// TangentZ.w contains sign of tangent basis determinant
		HALF4_TYPE	TangentZ	: ATTRIBUTE2;

	#endif

	float2	TexCoords0 : ATTRIBUTE3;
};

struct FVertexFactoryIntermediates
{
	float3 Position;
	half3 Normal;
	float4 TexCoords;

};

uint GetVertexIndex(in FVertexFactoryInput Input)
{
	return Input.VertexId + YQPhysicsVF.YQPhysicsVertexOffset;
}



Buffer<float4> PositionBuffer;
Buffer<half4> NormalBuffer;

FVertexFactoryIntermediates GetVertexFactoryIntermediates(FVertexFactoryInput Input)
{
	FVertexFactoryIntermediates Intermediates;
	Intermediates = (FVertexFactoryIntermediates)0;

	uint VertexIndex = GetVertexIndex(Input);

	uint BufferIndex = VertexIndex;

	float3 Position = PositionBuffer[BufferIndex].xyz;
	float3 Normal = NormalBuffer[BufferIndex].xyz;

	Intermediates.Position = Position;
	Intermediates.Normal = Input.TangentZ.xyz;


	float2 UV = 0.0;
	
	Intermediates.TexCoords.xy = Input.TexCoords0;

	//��Ϊ�õ���float4������ʼ���Ļ�����
	Intermediates.TexCoords.zw = 0;

	return Intermediates;
}

// 因为在计算物理时，位置已经是在世界空间的了，所以此处转为TranslatedWorld空间即可
float4 CalcWorldPosition(FVertexFactoryInput Input, FVertexFactoryIntermediates Intermediates)
{
	//return float4(Intermediates.Position + ResolvedView.PreViewTranslation.xyz, 1.0);


	FLWCVector3 WorldPosition = LWCPromote(Intermediates.Position);
	FLWCVector3 TranslatedWorldPosition = LWCAdd(WorldPosition, ResolvedView.PreViewTranslation);
	return float4(LWCToFloat(TranslatedWorldPosition), 1.0f);
	//return float4(Intermediates.Position, 1.0);
}

#endif